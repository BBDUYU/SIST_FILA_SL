<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fila.app.mapper.product.UserProductMapper">

  <select id="selectAllProducts" resultType="com.fila.app.domain.product.ProductsVO">
    SELECT 
        P.PRODUCT_ID    AS productId,
        P.NAME,
        P.PRICE,
        P.DISCOUNT_RATE AS discountRate,
        P.CATEGORY_ID   AS categoryId,
        P.CREATED_AT    AS createdAt,
        NVL(I.IMAGE_URL, '//filacdn.styleship.com/filaproduct2/data/productimages/a/1/FS261FT01X001_234.jpg') AS imageUrl,
        (SELECT CONNECT_BY_ROOT NAME FROM CATEGORIES WHERE CATEGORY_ID = P.CATEGORY_ID START WITH PARENT_ID IS NULL CONNECT BY PRIOR CATEGORY_ID = PARENT_ID) AS depth1Name,
        (SELECT M.VALUE_NAME FROM OPTION_VALUE_MASTERS M JOIN PRODUCT_OPTION_VALUES V ON M.V_MASTER_ID = V.V_MASTER_ID JOIN PRODUCT_OPTION_GROUPS G ON V.OPTION_GROUP_ID = G.OPTION_GROUP_ID WHERE G.PRODUCT_ID = P.PRODUCT_ID AND G.MASTER_ID = 2 AND ROWNUM = 1) AS tagName,
        NVL(R.REVIEW_COUNT, 0) AS reviewCount,
        NVL(R.AVG_RATING, 0.0) AS reviewScore,
        NVL(W.WISH_COUNT, 0)   AS likeCount
    FROM PRODUCTS P
    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_ID = I.PRODUCT_ID AND I.IS_MAIN = 1
    LEFT JOIN (SELECT PRODUCT_ID, COUNT(*) as REVIEW_COUNT, ROUND(AVG(RATING), 1) as AVG_RATING FROM REVIEW GROUP BY PRODUCT_ID) R ON P.PRODUCT_ID = R.PRODUCT_ID
    LEFT JOIN (SELECT PRODUCT_ID, COUNT(*) as WISH_COUNT FROM WISHLIST GROUP BY PRODUCT_ID) W ON P.PRODUCT_ID = W.PRODUCT_ID
    ORDER BY P.CREATED_AT DESC
  </select>

  <select id="selectProductsByCategory" resultType="com.fila.app.domain.product.ProductsVO">
    SELECT 
        P.PRODUCT_ID    AS productId,
        P.NAME,
        P.PRICE,
        P.DISCOUNT_RATE AS discountRate,
        P.CATEGORY_ID   AS categoryId,
        P.CREATED_AT    AS createdAt,
        NVL(I.IMAGE_URL, '//filacdn.styleship.com/filaproduct2/data/productimages/a/1/FS261FT01X001_234.jpg') AS imageUrl,
        (SELECT CONNECT_BY_ROOT NAME FROM CATEGORIES WHERE CATEGORY_ID = P.CATEGORY_ID START WITH PARENT_ID IS NULL CONNECT BY PRIOR CATEGORY_ID = PARENT_ID) AS depth1Name,
        (SELECT M.VALUE_NAME FROM OPTION_VALUE_MASTERS M JOIN PRODUCT_OPTION_VALUES V ON M.V_MASTER_ID = V.V_MASTER_ID JOIN PRODUCT_OPTION_GROUPS G ON V.OPTION_GROUP_ID = G.OPTION_GROUP_ID WHERE G.PRODUCT_ID = P.PRODUCT_ID AND G.MASTER_ID = 2 AND ROWNUM = 1) AS tagName,
        NVL(R.REVIEW_COUNT, 0) AS reviewCount,
        NVL(R.AVG_RATING, 0.0) AS reviewScore,
        NVL(W.WISH_COUNT, 0)   AS likeCount
    FROM PRODUCTS P
    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_ID = I.PRODUCT_ID AND I.IS_MAIN = 1
    LEFT JOIN (SELECT PRODUCT_ID, COUNT(*) as REVIEW_COUNT, ROUND(AVG(RATING), 1) as AVG_RATING FROM REVIEW GROUP BY PRODUCT_ID) R ON P.PRODUCT_ID = R.PRODUCT_ID
    LEFT JOIN (SELECT PRODUCT_ID, COUNT(*) as WISH_COUNT FROM WISHLIST GROUP BY PRODUCT_ID) W ON P.PRODUCT_ID = W.PRODUCT_ID
    WHERE P.CATEGORY_ID IN (
        SELECT CATEGORY_ID FROM CATEGORIES
        START WITH CATEGORY_ID = #{cateId} 
        CONNECT BY PRIOR CATEGORY_ID = PARENT_ID
    )
    ORDER BY P.CREATED_AT DESC
  </select>

  <select id="getProduct" resultType="com.fila.app.domain.product.ProductsVO">
    SELECT 
        P.PRODUCT_ID    AS productId, 
        P.NAME, 
        P.PRICE, 
        P.DISCOUNT_RATE AS discountRate, 
        P.STATUS, 
        P.DESCRIPTION, 
        P.CREATED_AT    AS createdAt, 
        P.CATEGORY_ID   AS categoryId, 
        NVL(I.IMAGE_URL, '//filacdn.styleship.com/filaproduct2/data/productimages/a/1/FS261FT01X001_234.jpg') AS imageUrl
    FROM PRODUCTS P 
    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_ID = I.PRODUCT_ID AND I.IS_MAIN = 1
    WHERE P.PRODUCT_ID = #{productId}
  </select>

  <select id="selectProductsBySearch" resultType="com.fila.app.domain.product.ProductsVO">
    SELECT 
        P.PRODUCT_ID    AS productId,
        P.NAME,
        P.PRICE,
        P.DISCOUNT_RATE AS discountRate,
        NVL(I.IMAGE_URL, '//filacdn.styleship.com/filaproduct2/data/productimages/a/1/FS261FT01X001_234.jpg') AS imageUrl,
        NVL(R.REVIEW_COUNT, 0) AS reviewCount,
        NVL(R.AVG_RATING, 0.0) AS reviewScore
    FROM PRODUCTS P
    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_ID = I.PRODUCT_ID AND I.IS_MAIN = 1
    LEFT JOIN (SELECT PRODUCT_ID, COUNT(*) as REVIEW_COUNT, ROUND(AVG(RATING), 1) as AVG_RATING FROM REVIEW GROUP BY PRODUCT_ID) R ON P.PRODUCT_ID = R.PRODUCT_ID
    WHERE P.NAME LIKE '%' || #{searchItem} || '%' 
    ORDER BY P.CREATED_AT DESC
  </select>
  
  <select id="getProductOptions" resultType="com.fila.app.domain.product.ProductsOptionVO">
    SELECT DISTINCT 
        POC.COMBINATION_ID AS combinationId, 
        OVM.VALUE_NAME AS optionValue, 
        NVL(POS.STOCK, 0) AS stock
    FROM PRODUCT_OPTION_COMBINATIONS POC
    JOIN PRODUCT_OPTION_COMBI_VALUES POCV ON POC.COMBINATION_ID = POCV.COMBINATION_ID
    JOIN PRODUCT_OPTION_VALUES POV ON POCV.VALUE_ID = POV.VALUE_ID
    JOIN OPTION_VALUE_MASTERS OVM ON POV.V_MASTER_ID = OVM.V_MASTER_ID
    LEFT JOIN PRODUCT_OPTION_STOCK POS ON POC.COMBINATION_ID = POS.COMBINATION_ID
    WHERE POC.PRODUCT_ID = #{productId}
    AND OVM.MASTER_ID NOT IN (1, 2, 3)
    ORDER BY OVM.VALUE_NAME ASC
  </select>
  
  <select id="selectCategory" resultType="com.fila.app.domain.categories.CategoriesVO">
    SELECT 
        CATEGORY_ID AS categoryId,
        NAME,
        PARENT_ID AS parentId,
        DEPTH
    FROM CATEGORIES
    WHERE CATEGORY_ID = #{categoryId}
  </select>
  
  <select id="selectMainCategories" resultType="com.fila.app.domain.categories.CategoriesVO">
    SELECT 
        C.CATEGORY_ID AS categoryId,
        C.NAME,
        C.PARENT_ID AS parentId,
        C.DEPTH,
        (SELECT COUNT(*) FROM PRODUCTS P WHERE P.CATEGORY_ID IN (SELECT CATEGORY_ID FROM CATEGORIES START WITH CATEGORY_ID = C.CATEGORY_ID CONNECT BY PRIOR CATEGORY_ID = PARENT_ID)) AS productCount
    FROM CATEGORIES C
    WHERE C.DEPTH = 1
    ORDER BY C.CATEGORY_ID ASC
  </select>
  
  <select id="selectChildCategories" resultType="com.fila.app.domain.categories.CategoriesVO">
    SELECT 
        C.CATEGORY_ID AS categoryId,
        C.NAME,
        C.PARENT_ID AS parentId,
        C.DEPTH,
        (SELECT COUNT(*) FROM PRODUCTS P WHERE P.CATEGORY_ID IN (SELECT CATEGORY_ID FROM CATEGORIES START WITH CATEGORY_ID = C.CATEGORY_ID CONNECT BY PRIOR CATEGORY_ID = PARENT_ID)) AS productCount
    FROM CATEGORIES C
    WHERE C.PARENT_ID = #{parentId}
    ORDER BY C.CATEGORY_ID ASC
  </select>
  
  <select id="getProductTag" resultType="string">
    SELECT M.VALUE_NAME
    FROM OPTION_VALUE_MASTERS M
    JOIN PRODUCT_OPTION_VALUES V ON M.V_MASTER_ID = V.V_MASTER_ID
    JOIN PRODUCT_OPTION_GROUPS G ON V.OPTION_GROUP_ID = G.OPTION_GROUP_ID
    WHERE G.PRODUCT_ID = #{productId} AND G.MASTER_ID = #{masterId}
  </select>

</mapper>