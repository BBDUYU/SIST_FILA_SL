<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.admin.CouponMapper">

    <select id="selectList" resultType="com.fila.app.domain.admin.CouponVO">
        SELECT 
            COUPON_ID      AS couponId,
            NAME,
            DISCOUNT_TYPE  AS discountType,
            DISCOUNT_VALUE AS discountValue,
            EXPIRES_AT     AS expiresAt,
            CREATED_AT     AS createdAt,
            STATUS,
            SERIAL_NUMBER  AS serialNumber
        FROM COUPON 
        ORDER BY CREATED_AT DESC
    </select>

    <insert id="insertCoupon">
        INSERT INTO COUPON (
            COUPON_ID, NAME, DISCOUNT_TYPE, DISCOUNT_VALUE, 
            SERIAL_NUMBER, EXPIRES_AT, CREATED_AT
        ) VALUES (
            SEQ_COUPON.NEXTVAL, #{name}, #{discountType}, #{discountValue}, 
            #{serialNumber}, #{expiresAt, jdbcType=DATE}, SYSDATE
        )
    </insert>

    <select id="getUserCouponList" resultType="com.fila.app.domain.admin.UserInfoVO">
        SELECT 
            uc.USER_COUPON_ID AS userCouponId, 
            c.NAME           AS couponName, 
            c.DISCOUNT_TYPE  AS discountType, 
            c.DISCOUNT_VALUE AS price, 
            uc.IS_USED       AS isUsed, 
            uc.USED_AT       AS usedAt, 
            uc.EXPIRE_DATE   AS expiredDate, 
            uc.RECEIVED_AT   AS receivedAt, 
            c.STATUS
        FROM USER_COUPON uc 
        JOIN COUPON c ON uc.COUPON_ID = c.COUPON_ID 
        WHERE uc.USER_NUMBER = #{userNumber} 
        ORDER BY uc.RECEIVED_AT DESC
    </select>

    <update id="updateStatus">
        UPDATE COUPON SET STATUS = #{status} WHERE COUPON_ID = #{couponId}
    </update>

    <update id="useUserCoupon">
        UPDATE USER_COUPON 
        SET IS_USED = '1', USED_AT = SYSDATE 
        WHERE USER_COUPON_ID = #{userCouponId}
    </update>

</mapper>