<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.address.AddressMapper">

  <resultMap id="addressMap" type="com.fila.app.domain.address.AddressVO">
    <id property="addressId" column="ADDRESS_ID"/>
    <result property="userNumber" column="USER_NUMBER"/>
    <result property="addressName" column="ADDRESS_NAME"/>
    <result property="recipientName" column="RECIPIENT_NAME"/>
    <result property="recipientPhone" column="RECIPIENT_PHONE"/>
    <result property="zipcode" column="ZIPCODE"/>
    <result property="mainAddr" column="MAIN_ADDR"/>
    <result property="detailAddr" column="DETAIL_ADDR"/>
    <result property="isDefault" column="IS_DEFAULT"/>
  </resultMap>

  <update id="clearDefault">
    UPDATE DELIVERY_ADDRESS SET IS_DEFAULT = 0 WHERE USER_NUMBER = #{userNumber}
  </update>

  <insert id="insert">
    INSERT INTO DELIVERY_ADDRESS
    (ADDRESS_ID, USER_NUMBER, ADDRESS_NAME, RECIPIENT_NAME, RECIPIENT_PHONE, ZIPCODE, MAIN_ADDR, DETAIL_ADDR, IS_DEFAULT)
    VALUES (DELIVERY_ADDRESS_SEQ.NEXTVAL, #{userNumber}, #{addressName}, #{recipientName}, #{recipientPhone}, #{zipcode}, #{mainAddr}, #{detailAddr}, #{isDefault})
  </insert>

  <update id="update">
    UPDATE DELIVERY_ADDRESS
    SET ADDRESS_NAME=#{addressName}, 
        RECIPIENT_NAME=#{recipientName}, 
        RECIPIENT_PHONE=#{recipientPhone}, 
        ZIPCODE=#{zipcode}, 
        MAIN_ADDR=#{mainAddr}, 
        DETAIL_ADDR=#{detailAddr}, 
        IS_DEFAULT=#{isDefault}
    WHERE ADDRESS_ID=#{addressId} AND USER_NUMBER=#{userNumber}
  </update>

  <select id="selectListByUser" resultMap="addressMap">
    SELECT ADDRESS_ID, USER_NUMBER, ADDRESS_NAME, RECIPIENT_NAME, RECIPIENT_PHONE,
           ZIPCODE, MAIN_ADDR, DETAIL_ADDR, IS_DEFAULT
    FROM DELIVERY_ADDRESS
    WHERE USER_NUMBER = #{userNumber}
    ORDER BY IS_DEFAULT DESC, ADDRESS_ID DESC
  </select>

  <update id="setDefault">
    UPDATE DELIVERY_ADDRESS
    SET IS_DEFAULT = 1
    WHERE ADDRESS_ID = #{addressId} AND USER_NUMBER = #{userNumber}
  </update>

  <select id="isDefault" resultType="int">
    SELECT NVL(IS_DEFAULT,0) FROM DELIVERY_ADDRESS WHERE ADDRESS_ID=#{addressId} AND USER_NUMBER=#{userNumber}
  </select>

  <delete id="delete">
    DELETE FROM DELIVERY_ADDRESS WHERE ADDRESS_ID=#{addressId} AND USER_NUMBER=#{userNumber}
  </delete>

  <select id="hasOrderReference" resultType="int">
    SELECT COUNT(1)
    FROM ORDERS
    WHERE USER_NUMBER = #{userNumber}
      AND ADDRESS_ID = #{addressId}
  </select>

  <select id="selectOneById" resultMap="addressMap">
    SELECT ADDRESS_ID, USER_NUMBER, ADDRESS_NAME, RECIPIENT_NAME, RECIPIENT_PHONE,
           ZIPCODE, MAIN_ADDR, DETAIL_ADDR, IS_DEFAULT
    FROM DELIVERY_ADDRESS
    WHERE ADDRESS_ID = #{addressId} AND USER_NUMBER = #{userNumber}
  </select>

</mapper>