<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fila.app.mapper.mypage.coupon.MypageCouponMapper">

    <select id="selectMyCouponList" resultType="com.fila.app.domain.mypage.coupon.MypageCouponVO">
	    SELECT
	        uc.USER_COUPON_ID     AS userCouponId,
	        uc.COUPON_ID          AS couponId,
	        uc.IS_USED            AS isUsed,
	        uc.EXPIRE_DATE        AS expireDate,
	        uc.RECEIVED_AT        AS receivedAt,
	        c.NAME                AS couponName,
	        c.DISCOUNT_TYPE       AS discountType,
	        c.DISCOUNT_VALUE      AS discountValue
	    FROM USER_COUPON uc
	    JOIN COUPON c ON uc.COUPON_ID = c.COUPON_ID
	    WHERE uc.USER_NUMBER = #{userNumber}
	      AND uc.IS_USED = 0   AND uc.EXPIRE_DATE >= SYSDATE ORDER BY uc.RECEIVED_AT DESC
	</select>

    <select id="selectCouponMasterBySerial" resultType="com.fila.app.domain.admin.CouponVO">
	    SELECT COUPON_ID as couponId, EXPIRES_AT as expiresAt
	    FROM COUPON
	    WHERE SERIAL_NUMBER = #{serialNo}
	      AND STATUS = 'Y'
	</select>

    <select id="countUserCoupon" resultType="int">
        SELECT COUNT(*)
        FROM USER_COUPON
        WHERE USER_NUMBER = #{userNumber}
          AND COUPON_ID = #{couponId}
    </select>

    <insert id="insertUserCoupon">
	    INSERT INTO USER_COUPON
	        (USER_COUPON_ID, COUPON_ID, USER_NUMBER, IS_USED, EXPIRE_DATE, RECEIVED_AT)
	    VALUES
	        (SEQ_USER_COUPON.NEXTVAL, #{couponId}, #{userNumber}, 0, #{expireDate, jdbcType=DATE}, SYSDATE)
	</insert>

</mapper>
