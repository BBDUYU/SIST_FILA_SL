<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fila.app.mapper.qna.QnaMapper">

  <insert id="insert">
    INSERT INTO qna (
        qna_id, product_id, user_number, type, 
        question, is_secret, status, created_at,
        answer_email, is_email_notify
    ) VALUES (
        seq_qna.nextval, #{productId}, #{userNumber}, #{type}, 
        #{question}, #{isSecret}, 'WAITING', SYSDATE,
        #{answerEmail, jdbcType=VARCHAR}, #{isEmailNotify}
    )
  </insert>

  <select id="selectList" resultType="com.fila.app.domain.qna.QnaVO">
    SELECT 
        q.qna_id      AS qnaId, 
        q.product_id   AS productId, 
        q.user_number  AS userNumber, 
        q.type, 
        q.question, 
        q.answer, 
        q.status, 
        q.is_secret    AS isSecret, 
        q.created_at   AS createdAt, 
        q.answered_at  AS answeredAt,
        u.id           AS userId
    FROM qna q
    LEFT JOIN users u ON q.user_number = u.user_number
    WHERE q.product_id = #{productId}
    ORDER BY q.qna_id DESC
  </select>

  <select id="selectAdminQnaList" resultType="com.fila.app.domain.qna.QnaVO">
    SELECT 
        q.qna_id      AS qnaId, 
        q.product_id   AS productId, 
        q.user_number  AS userNumber, 
        q.type, 
        q.question, 
        q.answer, 
        q.status, 
        q.is_secret    AS isSecret, 
        q.created_at   AS createdAt,
        u.name         AS name
    FROM qna q
    JOIN users u ON q.user_number = u.user_number
    ORDER BY q.qna_id DESC
  </select>

  <select id="selectQnaDetail" resultType="com.fila.app.domain.qna.QnaVO">
    SELECT 
        q.qna_id      AS qnaId,
        q.product_id   AS productId,
        q.user_number  AS userNumber,
        q.type,
        q.question,
        q.answer,
        q.status,
        q.is_secret    AS isSecret,
        q.created_at   AS createdAt,
        q.answered_at  AS answeredAt,
        u.name         AS name 
    FROM qna q
    JOIN users u ON q.user_number = u.user_number
    WHERE q.qna_id = #{qnaId}
  </select>
  
  <update id="updateAnswer">
    UPDATE qna 
    SET answer = #{answer}, 
        status = 'COMPLETE', 
        answered_at = SYSDATE 
    WHERE qna_id = #{qnaId}
  </update>

</mapper>