<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.persistence.admin.TagProductsMapper">

    <select id="selectProductsByTag" resultType="com.fila.app.domain.admin.ProductVO">
        SELECT 
            P.PRODUCT_ID, 
            P.NAME, 
            P.PRICE, 
            P.DISCOUNT_RATE, 
            P.STATUS, 
            P.CATEGORY_ID, 
            NVL(I.IMAGE_URL, '//filacdn.styleship.com/filaproduct2/data/productimages/a/1/FS261FT01X001_234.jpg') AS IMAGE_URL
        FROM PRODUCTS P
        LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_ID = I.PRODUCT_ID AND I.IS_MAIN = 1
        WHERE P.PRODUCT_ID IN (
            SELECT PRODUCT_ID 
            FROM PRODUCT_CATEGORY_REL 
            WHERE CATEGORY_ID = #{tagId}
        )
        AND P.STATUS != 'SOLDOUT'
        ORDER BY P.CREATED_AT DESC
    </select>

</mapper>