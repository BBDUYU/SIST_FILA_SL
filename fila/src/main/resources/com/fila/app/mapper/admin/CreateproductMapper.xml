<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.admin.CreateproductMapper">

    <select id="generateProductId" resultType="string">
        SELECT 
	    <choose>
	        <when test="mainCateId == 1"> 'PROD' || seq_prod_men.NEXTVAL </when>
	        <when test="mainCateId == 2"> 'PROD' || seq_prod_women.NEXTVAL </when>
	        <when test="mainCateId == 3"> 'PROD' || seq_prod_kids.NEXTVAL </when>
	        <otherwise> 'PROD' || seq_prod_men.NEXTVAL </otherwise>
	    </choose>
	    FROM DUAL
    </select>

    <insert id="insertProduct">
        INSERT INTO PRODUCTS (
            product_id, category_id, name, description, price, 
            view_count, created_at, updated_at, status, discount_rate
        ) VALUES (
            #{productId}, #{categoryId}, #{name}, #{description, jdbcType=VARCHAR}, #{price}, 
            0, SYSDATE, SYSDATE, 
            <choose>
                <when test="discountRate > 0">'SALE'</when>
                <otherwise>'NORMAL'</otherwise>
            </choose>, 
            #{discountRate}
        )
    </insert>

    <update id="updateProduct">
        UPDATE PRODUCTS 
        SET name = #{name}, 
            description = #{description, jdbcType=VARCHAR}, 
            price = #{price}, 
            discount_rate = #{discountRate},
            updated_at = SYSDATE
        WHERE product_id = #{productId}
    </update>

    <select id="selectProductById" resultType="com.fila.app.domain.admin.CreateproductVO">
        SELECT 
            p.PRODUCT_ID    AS productId, 
            p.CATEGORY_ID   AS categoryId,
            p.NAME, 
            p.DESCRIPTION, 
            p.PRICE,
            p.VIEW_COUNT    AS viewCount,
            p.CREATED_AT    AS createdAt,
            p.UPDATED_AT    AS updatedAt,
            p.STATUS,
            p.DISCOUNT_RATE AS discountRate,
            (SELECT STYLE_ID FROM STYLE_PRODUCT WHERE PRODUCT_ID = p.PRODUCT_ID AND ROWNUM = 1) AS styleId, 
            (SELECT SECTION_ID FROM EVENT_PRODUCT WHERE PRODUCT_ID = p.PRODUCT_ID AND ROWNUM = 1) AS sectionId, 
            c.NAME          AS genderName, 
            c.CATEGORY_ID   AS genderOptionId, 
            (SELECT NAME FROM CATEGORIES WHERE CATEGORY_ID = (SELECT PARENT_ID FROM CATEGORIES WHERE CATEGORY_ID = p.CATEGORY_ID)) AS categoryType, 
            (SELECT SUM(STOCK) FROM PRODUCT_OPTION_STOCK pos JOIN PRODUCT_OPTION_COMBINATIONS poc ON pos.COMBINATION_ID = poc.COMBINATION_ID WHERE poc.PRODUCT_ID = p.PRODUCT_ID) AS stock, 
            (SELECT POV.V_MASTER_ID FROM PRODUCT_OPTION_VALUES POV JOIN PRODUCT_OPTION_GROUPS POG ON POV.OPTION_GROUP_ID = POG.OPTION_GROUP_ID WHERE POG.PRODUCT_ID = p.PRODUCT_ID AND POG.MASTER_ID = 2 AND ROWNUM = 1) AS sportOptionId 
        FROM PRODUCTS p 
        JOIN CATEGORIES c ON p.CATEGORY_ID = c.CATEGORY_ID 
        WHERE p.PRODUCT_ID = #{productId}
    </select>

    <update id="updateProductStatusDeleted">
        UPDATE PRODUCTS SET STATUS = 'DELETED', UPDATED_AT = SYSDATE WHERE PRODUCT_ID = #{productId}
    </update>

    <insert id="insertProductImage">
        INSERT INTO product_image (product_image_id, product_id, image_url, image_type, is_main, sort_order) 
        VALUES (prod_img_seq.NEXTVAL, #{productId}, #{imageUrl}, #{imageType}, #{isMain}, #{sortOrder})
    </insert>

    <select id="selectImagesByProductId" resultType="com.fila.app.domain.admin.CreateproductVO">
        SELECT 
            product_image_id AS productImageId,
            product_id       AS productId,
            image_url        AS imageUrl,
            image_type       AS imageType,
            is_main          AS isMain,
            sort_order       AS sortOrder
        FROM PRODUCT_IMAGE 
        WHERE PRODUCT_ID = #{productId} 
        ORDER BY SORT_ORDER ASC
    </select>

    <select id="getImagePathsByIds" resultType="string">
        SELECT image_url FROM product_image 
        WHERE product_image_id IN 
        <foreach item="id" collection="imageIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <delete id="deleteSpecificImages">
        DELETE FROM product_image WHERE product_image_id IN 
        <foreach item="id" collection="imageIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteAllImagesByProductId">
        DELETE FROM product_image WHERE product_id = #{productId}
    </delete>

    <insert id="insertCategoryRelation">
        INSERT INTO PRODUCT_CATEGORY_REL (REL_ID, PRODUCT_ID, CATEGORY_ID)
        VALUES (REL_SEQ.NEXTVAL, #{productId}, #{categoryId})
    </insert>

    <select id="selectProductCategories" resultType="map">
        SELECT CATEGORY_ID AS "categoryId" FROM PRODUCT_CATEGORY_REL WHERE PRODUCT_ID = #{productId}
    </select>

    <delete id="deleteCategoryRelations">
        DELETE FROM PRODUCT_CATEGORY_REL WHERE PRODUCT_ID = #{productId}
    </delete>

    <select id="selectAllOptions" resultType="map">
        SELECT 
            MASTER_ID    AS "masterId", 
            V_MASTER_ID  AS "vMasterId", 
            VALUE_NAME   AS "valueName"
        FROM OPTION_VALUE_MASTERS 
        ORDER BY MASTER_ID, V_MASTER_ID
    </select>

    <select id="selectProductSizeIds" resultType="int">
        SELECT POV.V_MASTER_ID 
        FROM PRODUCT_OPTION_VALUES POV 
        JOIN PRODUCT_OPTION_GROUPS POG ON POV.OPTION_GROUP_ID = POG.OPTION_GROUP_ID 
        WHERE POG.PRODUCT_ID = #{productId} 
        AND POG.MASTER_ID IN (4,5,6,7,8)
    </select>

    <select id="selectActiveEventSections" resultType="map">
	    SELECT 
	        s.SECTION_ID AS "sectionId",
	        (e.EVENT_NAME || ' - 섹션 ' || s.SECTION_ID) AS "name"
	    FROM EVENT e 
	    JOIN EVENT_SECTION s ON e.EVENT_ID = s.EVENT_ID
	    WHERE e.IS_ACTIVE = 1 
	    ORDER BY e.EVENT_ID, s.SORT_ORDER
	</select>

	<select id="selectAllCategories" resultType="map">
	    SELECT 
	        CATEGORY_ID AS "categoryId", 
	        NAME        AS "name", 
	        PARENT_ID   AS "parentId", 
	        DEPTH       AS "depth"
	    FROM CATEGORIES
	    ORDER BY DEPTH, CATEGORY_ID
	</select>

    <insert id="insertOptionGroup" parameterType="map">
	    <selectKey keyProperty="optionGroupId" resultType="long" order="BEFORE">
	        SELECT SEQ_OPTION_GROUP.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO PRODUCT_OPTION_GROUPS (OPTION_GROUP_ID, PRODUCT_ID, MASTER_ID, OPTION_NAME)
	    VALUES (#{optionGroupId}, #{productId}, #{masterId}, 
	            (SELECT OPTION_NAME FROM OPTION_MASTERS WHERE MASTER_ID = #{masterId}))
	</insert>

    <insert id="insertOptionValue" useGeneratedKeys="true" keyProperty="valueId">
    <selectKey keyProperty="valueId" resultType="long" order="BEFORE">
        SELECT SEQ_OPTION_VALUE.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO PRODUCT_OPTION_VALUES (VALUE_ID, OPTION_GROUP_ID, V_MASTER_ID, VALUE_NAME) 
    VALUES (
        #{valueId}, 
        #{optionGroupId}, 
        #{vMasterId}, 
        (SELECT VALUE_NAME FROM OPTION_VALUE_MASTERS WHERE V_MASTER_ID = #{vMasterId})
    )
</insert>

    <insert id="insertCombination" useGeneratedKeys="true" keyProperty="combinationId">
        <selectKey keyProperty="combinationId" resultType="long" order="BEFORE">
            SELECT SEQ_COMBINATION.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO PRODUCT_OPTION_COMBINATIONS (COMBINATION_ID, PRODUCT_ID) 
        VALUES (#{combinationId}, #{productId})
    </insert>

    <insert id="insertStock">
        INSERT INTO PRODUCT_OPTION_STOCK (STOCK_ID, COMBINATION_ID, STORE_ID, STOCK, IS_SOLDOUT) 
        VALUES (SEQ_STOCK.NEXTVAL, #{combinationId}, 4, #{stock}, #{isSoldout})
    </insert>

    <insert id="insertCombiValue">
        INSERT INTO PRODUCT_OPTION_COMBI_VALUES (VALUE_ID, COMBINATION_ID) VALUES (#{valueId}, #{combinationId})
    </insert>

    <insert id="insertStyleProduct">
        INSERT INTO STYLE_PRODUCT (PRODUCT_ID, STYLE_ID, SORT_ORDER) VALUES (#{productId}, #{styleId}, 1)
    </insert>

    <insert id="insertEventProduct">
        INSERT INTO EVENT_PRODUCT (PRODUCT_ID, SECTION_ID) VALUES (#{productId}, #{sectionId})
    </insert>

    <delete id="deleteStyleProduct">
        DELETE FROM STYLE_PRODUCT WHERE PRODUCT_ID = #{productId}
    </delete>

    <delete id="deleteEventProduct">
        DELETE FROM EVENT_PRODUCT WHERE PRODUCT_ID = #{productId}
    </delete>

    <delete id="deleteOptionCombiValues">
        DELETE FROM PRODUCT_OPTION_COMBI_VALUES WHERE COMBINATION_ID IN 
        (SELECT COMBINATION_ID FROM PRODUCT_OPTION_COMBINATIONS WHERE PRODUCT_ID = #{productId})
    </delete>

    <delete id="deleteOptionStock">
        DELETE FROM PRODUCT_OPTION_STOCK WHERE COMBINATION_ID IN 
        (SELECT COMBINATION_ID FROM PRODUCT_OPTION_COMBINATIONS WHERE PRODUCT_ID = #{productId})
    </delete>

    <delete id="deleteOptionCombinations">
        DELETE FROM PRODUCT_OPTION_COMBINATIONS WHERE PRODUCT_ID = #{productId}
    </delete>

    <delete id="deleteOptionValues">
        DELETE FROM PRODUCT_OPTION_VALUES WHERE OPTION_GROUP_ID IN 
        (SELECT OPTION_GROUP_ID FROM PRODUCT_OPTION_GROUPS WHERE PRODUCT_ID = #{productId})
    </delete>

    <delete id="deleteOptionGroups">
        DELETE FROM PRODUCT_OPTION_GROUPS WHERE PRODUCT_ID = #{productId}
    </delete>

    <select id="selectAdminProductList" resultType="com.fila.app.domain.admin.ProductVO">
        SELECT 
            p.PRODUCT_ID    AS productId, 
            p.NAME, 
            p.PRICE, 
            p.DISCOUNT_RATE AS discountRate, 
            p.STATUS, 
            p.CREATED_AT    AS createdAt,
            (SELECT SUM(STOCK) 
             FROM PRODUCT_OPTION_STOCK pos 
             JOIN PRODUCT_OPTION_COMBINATIONS poc ON pos.COMBINATION_ID = poc.COMBINATION_ID 
             WHERE poc.PRODUCT_ID = p.PRODUCT_ID) AS totalStock,
            (SELECT IMAGE_URL 
             FROM product_image 
             WHERE product_id = p.PRODUCT_ID AND is_main = 1 AND ROWNUM = 1) AS mainImageUrl
        FROM PRODUCTS p
        WHERE p.STATUS != 'DELETED'
        ORDER BY p.CREATED_AT DESC
    </select>
    
    <select id="getProductOptionsDetail" resultType="map">
        SELECT DISTINCT 
            POC.COMBINATION_ID AS "combinationId", 
            OVM.VALUE_NAME     AS "optionValue", 
            NVL(POS.STOCK, 0)  AS "stock"
        FROM PRODUCT_OPTION_COMBINATIONS POC
        JOIN PRODUCT_OPTION_COMBI_VALUES POCV ON POC.COMBINATION_ID = POCV.COMBINATION_ID
        JOIN PRODUCT_OPTION_VALUES POV ON POCV.VALUE_ID = POV.VALUE_ID
        JOIN OPTION_VALUE_MASTERS OVM ON POV.V_MASTER_ID = OVM.V_MASTER_ID
        LEFT JOIN PRODUCT_OPTION_STOCK POS ON POC.COMBINATION_ID = POS.COMBINATION_ID
        WHERE POC.PRODUCT_ID = #{productId}
          AND OVM.MASTER_ID NOT IN (1, 2, 3)
        ORDER BY OVM.VALUE_NAME ASC
    </select>
    
    
</mapper>