<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.admin.StyleMapper">

    <select id="selectStyleList" resultType="com.fila.app.domain.admin.StyleVO">
        SELECT 
            s.STYLE_ID      AS styleId, 
            s.STYLE_NAME    AS styleName, 
            s.USE_YN        AS useYn, 
            s.DESCRIPTION, 
            si.IMAGE_URL    AS mainImageUrl
        FROM STYLE s
        LEFT JOIN STYLE_IMAGE si ON s.STYLE_ID = si.STYLE_ID AND si.IS_MAIN = 1
        ORDER BY s.STYLE_ID DESC
    </select>

    <insert id="insertStyle" useGeneratedKeys="true" keyProperty="styleId" keyColumn="STYLE_ID">
        <selectKey keyProperty="styleId" resultType="int" order="BEFORE">
            SELECT SEQ_STYLE.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO STYLE (STYLE_ID, STYLE_NAME, DESCRIPTION, USE_YN)
        VALUES (#{styleId}, #{styleName}, #{description}, #{useYn})
    </insert>

    <insert id="insertStyleImage">
        INSERT INTO STYLE_IMAGE (STYLE_IMAGE_ID, STYLE_ID, IMAGE_URL, IS_MAIN, SORT_ORDER, ALT_TEXT)
        VALUES (SEQ_STYLE_IMAGE.NEXTVAL, #{styleId}, #{imageUrl}, #{isMain}, #{sortOrder}, #{altText})
    </insert>

    <select id="selectStyleProductDetails" resultType="com.fila.app.domain.admin.StyleProductVO">
        SELECT 
            sp.PRODUCT_ID   AS productId, 
            sp.STYLE_ID     AS styleId, 
            sp.SORT_ORDER   AS sortOrder,
            p.NAME          AS productName, 
            p.PRICE,
            pi.IMAGE_URL    AS productImage
        FROM STYLE_PRODUCT sp
        JOIN PRODUCTS p ON sp.PRODUCT_ID = p.PRODUCT_ID
        LEFT JOIN PRODUCT_IMAGE pi ON p.PRODUCT_ID = pi.PRODUCT_ID AND pi.IS_MAIN = 1
        WHERE sp.STYLE_ID = #{styleId}
        ORDER BY sp.SORT_ORDER ASC
    </select>

    <delete id="deleteStyleImages">
        DELETE FROM STYLE_IMAGE WHERE STYLE_ID = #{styleId}
    </delete>

    <update id="updateStyleStatus">
        UPDATE STYLE SET USE_YN = #{status} WHERE STYLE_ID = #{id}
    </update>

    <select id="selectActiveStyleList" resultType="com.fila.app.domain.admin.StyleVO">
        SELECT 
            s.STYLE_ID      AS styleId,
            s.STYLE_NAME    AS styleName,
            si.IMAGE_URL    AS mainImageUrl
        FROM STYLE s
        LEFT JOIN STYLE_IMAGE si ON s.STYLE_ID = si.STYLE_ID AND si.IS_MAIN = 1
        WHERE s.USE_YN = 1
        ORDER BY s.STYLE_ID DESC
    </select>

	<insert id="insertStyleProduct" parameterType="com.fila.app.domain.admin.StyleProductVO">
    INSERT INTO STYLE_PRODUCT (
        STYLE_ID, 
        PRODUCT_ID, 
        SORT_ORDER
    ) VALUES (
        #{styleId}, 
        #{productId}, 
        #{sortOrder}
    )
</insert>
<select id="selectStyleDetail" parameterType="int" resultType="com.fila.app.domain.admin.StyleVO">
        SELECT 
            STYLE_ID    AS styleId,
            STYLE_NAME  AS styleName,
            DESCRIPTION,
            USE_YN      AS useYn
        FROM STYLE
        WHERE STYLE_ID = #{styleId}
    </select>

    <select id="selectStyleImages" parameterType="int" resultType="com.fila.app.domain.admin.StyleImageVO">
        SELECT 
            STYLE_IMAGE_ID AS styleImageId,
            STYLE_ID       AS styleId,
            IMAGE_URL      AS imageUrl,
            IS_MAIN        AS isMain,
            SORT_ORDER     AS sortOrder,
            ALT_TEXT       AS altText
        FROM STYLE_IMAGE
        WHERE STYLE_ID = #{styleId}
        ORDER BY SORT_ORDER ASC
    </select>

    <select id="selectMatchedProductIds" parameterType="int" resultType="string">
        SELECT PRODUCT_ID
        FROM STYLE_PRODUCT
        WHERE STYLE_ID = #{styleId}
        ORDER BY SORT_ORDER ASC
    </select>
    
    <update id="updateStyle" parameterType="com.fila.app.domain.admin.StyleVO">
        UPDATE STYLE SET
            STYLE_NAME = #{styleName},
            DESCRIPTION = #{description},
            USE_YN = #{useYn}
        WHERE STYLE_ID = #{styleId}
    </update>

    <delete id="deleteStyleProducts">
        DELETE FROM STYLE_PRODUCT WHERE STYLE_ID = #{styleId}
    </delete>
    
    <select id="getProductSizes" parameterType="string" resultType="string">
	    SELECT v.VALUE_NAME 
	    FROM PRODUCT_OPTION_VALUES v
	    JOIN PRODUCT_OPTION_GROUPS g ON v.OPTION_GROUP_ID = g.OPTION_GROUP_ID
	    WHERE g.PRODUCT_ID = #{productId} 
	      AND g.MASTER_ID IN (4,5,6,7,8) 
    </select>
</mapper>