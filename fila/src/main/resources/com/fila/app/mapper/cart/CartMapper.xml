<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.cart.CartMapper">

  <resultMap id="cartItemMap" type="com.fila.app.domain.cart.CartItemVO">
    <id property="cartItemId" column="CART_ITEM_ID"/>
    <result property="userNumber" column="USER_NUMBER"/>
    <result property="productId" column="PRODUCT_ID"/>
    <result property="productName" column="PRODUCT_NAME"/>
    <result property="originUnitPrice" column="ORIGIN_UNIT_PRICE"/>
    <result property="discountRate" column="DISCOUNT_RATE"/>
    <result property="saleUnitPrice" column="SALE_UNIT_PRICE"/>
    <result property="quantity" column="QUANTITY"/>
    <result property="lineAmount" column="LINE_AMOUNT"/>
    <result property="mainImageUrl" column="MAIN_IMAGE_URL"/>
    <result property="size" column="OPTION_SIZE"/>
  </resultMap>

  <select id="selectAll" resultType="com.fila.app.domain.cart.CartItemVO">
    SELECT
      ci.cart_item_id AS cartItemId,
      ci.user_number AS userNumber,
      ci.product_id AS productId,
      p.name AS productName,
      p.price AS originUnitPrice,
      NVL(p.discount_rate, 0) AS discountRate,
      ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) AS saleUnitPrice,
      ci.quantity AS quantity,
      (ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) * ci.quantity) AS lineAmount,
      NULL AS mainImageUrl,
      NULL AS size
    FROM cart_items ci
    JOIN products p ON ci.product_id = p.product_id
  </select>

  <select id="selectCartForOrder" resultType="com.fila.app.domain.order.OrderItemVO">
    SELECT
      ci.PRODUCT_ID AS productId, 
      p.NAME AS name, 
      ci.COMBINATION_ID AS combinationId, 
      ci.QUANTITY AS quantity,
      ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) AS price
    FROM CART_ITEMS ci
    JOIN PRODUCTS p ON ci.PRODUCT_ID = p.PRODUCT_ID
    WHERE ci.USER_NUMBER = #{userNumber}
  </select>

  <select id="selectSelectedCartItems" resultType="com.fila.app.domain.order.OrderItemVO">
	  SELECT ci.PRODUCT_ID AS productId, 
	         p.NAME AS productName,  ci.COMBINATION_ID AS combinationId, 
	         ci.QUANTITY AS quantity,
	         p.PRICE AS originalPrice,
	         ROUND(p.PRICE * (100 - NVL(p.DISCOUNT_RATE, 0)) / 100) AS price FROM CART_ITEMS ci
	  JOIN PRODUCTS p ON ci.PRODUCT_ID = p.PRODUCT_ID
	  WHERE ci.CART_ITEM_ID IN (${ids})
	</select>

  <select id="selectAllByUser" resultMap="cartItemMap">
    SELECT 
      ci.cart_item_id AS CART_ITEM_ID, 
      ci.user_number AS USER_NUMBER, 
      ci.product_id AS PRODUCT_ID, 
      p.name AS PRODUCT_NAME, 
      p.price AS ORIGIN_UNIT_PRICE, 
      NVL(p.discount_rate, 0) AS DISCOUNT_RATE, 
      ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) AS SALE_UNIT_PRICE, 
      ci.quantity AS QUANTITY, 
      (ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) * ci.quantity) AS LINE_AMOUNT, 
      (SELECT MAX(pi.image_url) FROM product_image pi WHERE pi.product_id = p.product_id AND pi.is_main = 1) AS MAIN_IMAGE_URL, 
      ovm.value_name AS OPTION_SIZE 
    FROM cart_items ci 
    JOIN products p ON p.product_id = ci.product_id 
    LEFT JOIN product_option_combinations poc ON ci.combination_id = poc.combination_id 
    LEFT JOIN product_option_combi_values pocv ON poc.combination_id = pocv.combination_id 
    LEFT JOIN product_option_values pov ON pocv.value_id = pov.value_id 
    LEFT JOIN option_value_masters ovm ON pov.v_master_id = ovm.v_master_id 
    WHERE ci.user_number = #{userNumber}
    ORDER BY ci.added_at DESC
  </select>
  
  <insert id="insertCart">
    INSERT INTO CART_ITEMS (
        CART_ITEM_ID, USER_NUMBER, PRODUCT_ID, QUANTITY, COMBINATION_ID, ADDED_AT
    )
    VALUES (
        (SELECT NVL(MAX(CART_ITEM_ID),0)+1 FROM CART_ITEMS),
        #{userNumber},
        #{productId},
        #{quantity},
        #{combinationId},
        SYSDATE
    )
  </insert>

  <delete id="deleteCartItems">
    DELETE FROM CART_ITEMS
	WHERE USER_NUMBER = #{userNumber}
		AND CART_ITEM_ID IN (${cartItemIds})

  </delete>
  
  <!-- cartItemId → productId -->
  <select id="getProductIdByCartItemId" resultType="string">
      SELECT PRODUCT_ID
      FROM CART_ITEMS
      WHERE CART_ITEM_ID = #{cartItemId}
  </select>
  	
  <!-- productId + size → combinationId -->
  <select id="findCombinationIdBySize" resultType="int">
      SELECT poc.COMBINATION_ID
      FROM PRODUCT_OPTION_COMBINATIONS poc
      JOIN PRODUCT_OPTION_COMBI_VALUES pov
        ON poc.COMBINATION_ID = pov.COMBINATION_ID
      WHERE poc.PRODUCT_ID = #{productId}
        AND pov.SIZE = #{size}
  </select>
  	
  <!-- 옵션 + 수량 업데이트 -->
  <update id="updateItemOption">
      UPDATE CART_ITEMS
      SET
          COMBINATION_ID = #{combinationId},
          QUANTITY = #{quantity}
      WHERE CART_ITEM_ID = #{cartItemId}
  </update>
  
  <update id="updateQty">
    UPDATE CART_ITEMS
    SET QUANTITY = #{qty}
    WHERE CART_ITEM_ID = #{cartItemId}
      AND USER_NUMBER = #{userNumber}
  </update>

  <delete id="deleteAllItems">
    DELETE FROM CART_ITEMS
    WHERE USER_NUMBER = #{userNumber}
  </delete>
  
  
  </mapper>