<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.wishlist.WishListMapper">

  <select id="selectWishListByUser" parameterType="int" resultType="com.fila.app.domain.mypage.WishListVO">
    SELECT
      W.WISHLIST_ID   AS wishlistId, 
      W.USER_NUMBER    AS userNumber, 
      W.PRODUCT_ID     AS productId, 
      W.SIZE_TEXT      AS sizeText, 
      W.CREATED_AT     AS createdAt,
      P.NAME           AS productName, 
      P.PRICE, 
      NVL(P.DISCOUNT_RATE, 0) AS discountRate,
      I.IMAGE_URL      AS imageUrl
    FROM WISHLIST W
    JOIN PRODUCTS P ON W.PRODUCT_ID = P.PRODUCT_ID
    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_ID = I.PRODUCT_ID AND I.IS_MAIN = 1
    WHERE W.USER_NUMBER = #{userNumber}
    ORDER BY W.CREATED_AT DESC, W.WISHLIST_ID DESC
  </select>

  <select id="existsUserProduct" resultType="int">
    SELECT COUNT(*) FROM WISHLIST WHERE USER_NUMBER = #{userNumber} AND PRODUCT_ID = #{productId}
  </select>

  <insert id="insertWish">
    INSERT INTO WISHLIST (WISHLIST_ID, USER_NUMBER, PRODUCT_ID, CREATED_AT, SIZE_TEXT)
    VALUES (SEQ_WISHLIST.NEXTVAL, #{userNumber}, #{productId}, SYSDATE, #{sizeText, jdbcType=VARCHAR})
  </insert>

  <delete id="deleteOne">
    DELETE FROM WISHLIST WHERE WISHLIST_ID = #{wishlistId} AND USER_NUMBER = #{userNumber}
  </delete>

  <delete id="deleteSelected">
    DELETE FROM WISHLIST
    WHERE USER_NUMBER = #{userNumber}
      AND WISHLIST_ID IN
      <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
      </foreach>
  </delete>

  <delete id="deleteByProduct">
    DELETE FROM WISHLIST WHERE USER_NUMBER = #{userNumber} AND PRODUCT_ID = #{productId}
  </delete>

  <select id="existsByProduct" resultType="boolean">
    SELECT COUNT(*) FROM WISHLIST WHERE USER_NUMBER = #{userNumber} AND PRODUCT_ID = #{productId}
  </select>

  <select id="selectWishedProductIds" resultType="string">
    SELECT PRODUCT_ID FROM WISHLIST WHERE USER_NUMBER = #{userNumber}
  </select>

</mapper>