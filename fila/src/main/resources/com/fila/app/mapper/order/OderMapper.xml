<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fila.app.mapper.order.OderMapper">

    <select id="generateOrderId" resultType="string">
        SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(SEQ_ORDER_ID.NEXTVAL, 4, '0')
        FROM DUAL
    </select>

    <insert id="insertOrder" parameterType="com.fila.app.domain.order.OrderVO">
        INSERT INTO ORDERS
            (ORDER_ID, USER_NUMBER, ADDRESS_ID, TOTAL_AMOUNT,
             ORDER_STATUS, CREATED_AT, DELIVERY_METHOD, DELIVERY_REQUEST)
        VALUES
            (#{orderId}, #{userNumber}, #{addressId}, #{totalAmount},
             '결제완료', SYSDATE, #{deliveryMethod}, #{deliveryRequest})
    </insert>

    <insert id="insertOrderItems">
        INSERT INTO ORDER_ITEMS
            (ORDER_ITEM_ID, ORDER_ID, PRODUCT_ID,
             COMBINATION_ID, QUANTITY, PRICE, CANCEL_STATUS, STATUS_UPDATED_AT)
        <foreach collection="items" item="item" separator="UNION ALL">
            SELECT
                SEQ_ORDER_ITEM.NEXTVAL,
                #{item.orderId},
                #{item.productId},
                <choose>
                    <when test="item.combinationId != null and item.combinationId &gt; 0">
                        #{item.combinationId}
                    </when>
                    <otherwise>NULL</otherwise>
                </choose>,
                #{item.quantity},
                #{item.price},
                'N',
                SYSDATE
            FROM DUAL
        </foreach>
    </insert>

    <select id="selectUserOrderList" resultType="com.fila.app.domain.order.OrderVO">
        SELECT 
            ORDER_ID       AS orderId,
            USER_NUMBER    AS userNumber,
            ADDRESS_ID     AS addressId,
            TOTAL_AMOUNT   AS totalAmount,
            ORDER_STATUS   AS orderStatus,
            CREATED_AT     AS createdAt,
            DELIVERY_METHOD AS deliveryMethod,
            DELIVERY_REQUEST AS deliveryRequest
        FROM ORDERS
        WHERE 1=1
        <if test="userNumber != null and userNumber &gt; 0">
            AND USER_NUMBER = #{userNumber}
        </if>
        <choose>
            <when test="type == 'ORDER'">
                AND ORDER_STATUS IN ('결제완료', '상품준비중', '배송준비중', '배송중', '배송완료')
            </when>
            <when test="type == 'CANCEL'">
                AND ORDER_STATUS IN ('취소요청', '반품요청', '취소완료', '반품완료')
            </when>
        </choose>
        ORDER BY CREATED_AT DESC
    </select>

    <select id="selectOrderItemsDetail" resultType="com.fila.app.domain.order.OrderItemVO">
        SELECT 
            i.PRODUCT_ID     AS productId,
            p.NAME           AS productName,
            i.QUANTITY,
            i.PRICE,
            i.COMBINATION_ID AS combinationId,
            v.VALUE_NAME     AS optionSize
        FROM ORDER_ITEMS i
        JOIN PRODUCTS p ON i.PRODUCT_ID = p.PRODUCT_ID
        LEFT JOIN PRODUCT_OPTION_COMBI_VALUES cv ON i.COMBINATION_ID = cv.COMBINATION_ID
        LEFT JOIN PRODUCT_OPTION_VALUES v ON cv.VALUE_ID = v.VALUE_ID
        WHERE i.ORDER_ID = #{orderId}
    </select>

    <select id="selectOrderById" resultType="com.fila.app.domain.order.OrderVO">
        SELECT 
            o.ORDER_ID        AS orderId,
            o.USER_NUMBER     AS userNumber,
            o.ADDRESS_ID      AS addressId,
            o.TOTAL_AMOUNT    AS totalAmount,
            o.ORDER_STATUS    AS orderStatus,
            o.CREATED_AT      AS createdAt,
            o.DELIVERY_METHOD  AS deliveryMethod,
            o.DELIVERY_REQUEST AS deliveryRequest,
            a.RECIPIENT_NAME  AS recipientName,
            a.RECIPIENT_PHONE AS recipientPhone,
            a.ZIPCODE,
            a.MAIN_ADDR       AS mainAddr,
            a.DETAIL_ADDR     AS detailAddr,
            p.PAYMENT_METHOD  AS paymentMethod
        FROM ORDERS o
        JOIN DELIVERY_ADDRESS a ON o.ADDRESS_ID = a.ADDRESS_ID
        LEFT JOIN PAYMENT p ON o.ORDER_ID = p.ORDER_ID
        WHERE o.ORDER_ID = #{orderId}
    </select>

    <update id="updateOrderStatus">
        UPDATE ORDERS SET ORDER_STATUS = #{status}, UPDATED_AT = SYSDATE WHERE ORDER_ID = #{orderId}
    </update>

</mapper>