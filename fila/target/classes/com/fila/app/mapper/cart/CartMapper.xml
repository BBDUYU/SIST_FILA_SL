<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fila.app.mapper.cart.CartMapper">

	<!-- ========================================================= 
	[1] 전체 조회 (CartItemDTO)
	========================================================= -->
	<select id="selectAll" resultType="com.fila.app.domain.order.CartItemVO">
		SELECT
		ci.cart_item_id AS cartItemId,
		ci.user_number AS userNumber,
		ci.product_id AS productId,
		p.name AS productName,
		p.price AS originUnitPrice,
		NVL(p.discount_rate, 0) AS discountRate,
		ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) AS saleUnitPrice,
		ci.quantity AS quantity,
		(ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) * ci.quantity) AS lineAmount,
		NULL AS mainImageUrl,
		NULL AS size
		FROM cart_items ci
		JOIN products p ON ci.product_id = p.product_id
	</select>

	<!-- ========================================================= 
	[2] 주문 전환용 조회 (OrderItemDTO) 
	========================================================= -->
	<select id="selectCartForOrder"
		resultType="com.fila.app.domain.order.OrderItemVO">
		SELECT
		ci.PRODUCT_ID AS productId,
		p.NAME AS productName,
		ci.COMBINATION_ID AS combinationId,
		ci.QUANTITY AS quantity,
		ROUND(p.price * (100 - NVL(p.discount_rate,0)) / 100) AS price
		FROM CART_ITEMS ci
		JOIN PRODUCTS p ON ci.PRODUCT_ID = p.PRODUCT_ID
		WHERE ci.USER_NUMBER = #{userNumber}
	</select>

	<!-- ========================================================= 
	[3] 장바구니 비우기 
	========================================================= -->
	<delete id="deleteCartAfterOrder">
		DELETE FROM CART_ITEMS
		WHERE USER_NUMBER = #{userNumber}
	</delete>

	<!-- ========================================================= 
	[4] 수량 변경 
	========================================================= -->
	<update id="updateQuantity">
		UPDATE cart_items
		SET quantity = #{quantity}
		WHERE cart_item_id = #{cartItemId}
	</update>

	<!-- ========================================================= 
	[5] 선택 구매용 조회 (ids 문자열 그대로 IN에 넣음) - 주의: ids는 "1,2,3" 형태로만 들어와야 함 
	========================================================= -->
	<select id="selectSelectedCartItems" resultType="com.fila.app.domain.order.OrderItemVO">
		SELECT
		ci.PRODUCT_ID AS productId,
		p.NAME AS productName,
		ci.COMBINATION_ID AS combinationId,
		ci.QUANTITY AS quantity,
		p.PRICE AS originalPrice,
		ROUND(p.PRICE * (100 - NVL(p.DISCOUNT_RATE, 0)) / 100) AS price
		FROM CART_ITEMS ci
		JOIN PRODUCTS p ON ci.PRODUCT_ID = p.PRODUCT_ID
		WHERE ci.CART_ITEM_ID IN (${ids})
	</select>

	<!-- ========================================================= 
	[6] 선택 삭제 - cartItemIds는 "1,2,3" 형태 
	========================================================= -->
	<delete id="deleteCartItems">
		DELETE FROM CART_ITEMS
		WHERE USER_NUMBER = #{userNumber}
		AND CART_ITEM_ID IN (${cartItemIds})
	</delete>

</mapper>