<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fila.search.mapper.SearchMapper">

    <update id="upsertKeyword">
        MERGE INTO SEARCH_KEYWORDS t
        USING (SELECT #{keyword} AS KEYWORD FROM dual) s
        ON (t.KEYWORD = s.KEYWORD)
        WHEN MATCHED THEN
            UPDATE SET t.SEARCH_COUNT = t.SEARCH_COUNT + 1, t.LAST_SEARCH_DATE = SYSDATE
        WHEN NOT MATCHED THEN
            INSERT (KEYWORD_ID, KEYWORD, SEARCH_COUNT, LAST_SEARCH_DATE)
            VALUES (SEARCH_KEYWORDS_SEQ.NEXTVAL, s.KEYWORD, 1, SYSDATE)
    </update>

    <select id="selectTopKeywords" resultType="fila.search.domain.SearchDTO">
        <![CDATA[
        SELECT * FROM (
            SELECT KEYWORD_ID, KEYWORD, SEARCH_COUNT, LAST_SEARCH_DATE
            FROM SEARCH_KEYWORDS
            ORDER BY SEARCH_COUNT DESC
        ) WHERE ROWNUM <= #{limit}
        ]]>
    </select>

</mapper>